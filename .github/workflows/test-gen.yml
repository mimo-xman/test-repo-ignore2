name: Test Gen (new)

on:
  workflow_dispatch:
    inputs:
      creator_name:
        description: 'Creator Name'
        required: true
        default: 'Github Workflows (default name)'
        type: string
      max_retries:
        description: 'Max Retries'
        required: true
        default: '10'
        type: number
      email_service_name:
        description: 'Email Service Name'
        required: true
        default: 'EmailOnDeck'
        type: choice
        options:
          - EmailOnDeck
          - SmailPro
          - TempMailIO
          - TempMailOrg
          - TMailor
          - MailTM
      use_tor_in_browser:
        description: 'Use TOR in browser'
        required: true
        default: true
        type: boolean
      use_tor_in_mailservice:
        description: 'Use TOR in mail service'
        required: true
        default: true
        type: boolean
      trigger_another_run:
        description: 'Trigger another run'
        required: true
        default: true
        type: boolean

permissions:
  contents: read
  actions: write

jobs:
  test:
    runs-on: ubuntu-latest
    name: Test Instance
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install git+https://${{ secrets.PLAYWRIGHT_HELPER_GITHUB_TOKEN }}@github.com/za-zo/python-package--playwright-helper.git
          playwright install chrome
          sudo apt-get install -y xvfb
      
      - name: Install Tor
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
      
      - name: Configure Tor
        run: |
          echo "ControlPort 9151" | sudo tee -a /etc/tor/torrc
          echo "SocksPort 9150" | sudo tee -a /etc/tor/torrc
          echo "CookieAuthentication 0" | sudo tee -a /etc/tor/torrc
          echo "Log notice file /var/log/tor/log" | sudo tee -a /etc/tor/torrc
          sudo systemctl restart tor@default
          sleep 10
          sudo ss -tulpn | grep tor
          sudo systemctl status tor@default --no-pager

      - name: Ensure Chrome is installed
        run: |
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          ls -l /usr/bin/google-chrome

      - name: Run Python Code
        env:
          WORKFLOW_ID: ${{ github.run_number }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          CREATOR_NAME: ${{ github.event.inputs.creator_name }}
          TOR_PORT: 9150
          TOR_CONTROL_PORT: 9151
          MAX_RETRIES_FOR_GENERATE_ACCOUNT: ${{ github.event.inputs.max_retries || 10 }}
          ASK_BEFORE_CLOSE_BROWSER: false
          HEADLESS: true
          EMAIL_SERVICE_NAME: ${{ github.event.inputs.email_service_name || 'EmailOnDeck' }}
          USE_TOR_IN_BROWSER: ${{ github.event.inputs.use_tor_in_browser }}
          USE_TOR_IN_MAILSERVICE: ${{ github.event.inputs.use_tor_in_mailservice }}
          CHROME_PATH: "/usr/bin/google-chrome"
          PYTHONUNBUFFERED: "1"
        run: |
          xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" python app.pyz
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-artifacts
          path: |
            output/
            *.png
            *.html
            *.log
          retention-days: 5

      - name: Trigger another run
        if: ${{ github.event.inputs.trigger_another_run != 'false' }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          BASE_NAME=$(echo "${{ github.event.inputs.creator_name }}" | sed 's/ - Instance [0-9]*$//')
          
          gh workflow run test-gen.yml \
            --ref ${{ github.ref_name }} \
            -f creator_name="${BASE_NAME} - Instance ${{ github.run_number }}" \
            -f max_retries="${{ github.event.inputs.max_retries || '10' }}" \
            -f email_service_name="${{ github.event.inputs.email_service_name || 'EmailOnDeck' }}" \
            -f use_tor_in_browser="${{ github.event.inputs.use_tor_in_browser || 'true' }}" \
            -f use_tor_in_mailservice="${{ github.event.inputs.use_tor_in_mailservice || 'true' }}" \
            -f trigger_another_run="${{ github.event.inputs.trigger_another_run || 'true' }}"
