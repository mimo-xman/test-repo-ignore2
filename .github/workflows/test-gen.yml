name: Test Gen

on:
  # push:
  #   branches:
  #     - main
  workflow_dispatch:
   inputs:
    creator_name:
      description: 'Creator Name'
      required: true
      default: 'Github Workflows (default name)'
    max_retries:
      description: 'Max Retries'
      required: true
      default: '10'

permissions:
  contents: read
  actions: write

jobs:
  test:
    runs-on: ubuntu-latest
#     strategy:
#       matrix:
#         instance: [1, 2, 3, 4, 5, 6]
#       fail-fast: false
    name: Test Instance
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install git+https://${{ secrets.PLAYWRIGHT_HELPER_GITHUB_TOKEN }}@github.com/za-zo/python-package--playwright-helper.git
          playwright install chrome
          # Install xvfb for headed mode support if needed
          sudo apt-get install -y xvfb
      
      - name: Install Tor
        run: |
          sudo apt-get update
          sudo apt-get install -y tor
      
      - name: Configure Tor
        run: |
          # Configure Tor to match script defaults (9150/9151)
          echo "ControlPort 9151" | sudo tee -a /etc/tor/torrc
          echo "SocksPort 9150" | sudo tee -a /etc/tor/torrc
          echo "CookieAuthentication 0" | sudo tee -a /etc/tor/torrc
          echo "Log notice file /var/log/tor/log" | sudo tee -a /etc/tor/torrc
          
          # Restart Tor service to apply changes
          sudo systemctl restart tor@default
          
          # Wait for Tor to be ready
          sleep 10
          
          # Check status
          sudo ss -tulpn | grep tor
          sudo systemctl status tor@default --no-pager

      - name: Ensure Chrome is installed
        run: |
          # Install Google Chrome Stable ensuring /usr/bin/google-chrome exists
          wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
          sudo sh -c 'echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" >> /etc/apt/sources.list.d/google-chrome.list'
          sudo apt-get update
          sudo apt-get install -y google-chrome-stable
          ls -l /usr/bin/google-chrome

      - name: Run Python Code
        env:
          WORKFLOW_ID: ${{ github.run_number }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          CREATOR_NAME: ${{ github.event.inputs.creator_name }}
          TOR_PORT: 9150
          TOR_CONTROL_PORT: 9151
          MAX_RETRIES_FOR_GENERATE_ACCOUNT: ${{ github.event.inputs.max_retries || 10 }}
          ASK_BEFORE_CLOSE_BROWSER: false
          HEADLESS: true
          CHROME_PATH: "/usr/bin/google-chrome"
          PYTHONUNBUFFERED: "1"
        run: |
          # Run with xvfb just in case, though we patched HEADLESS=True
          xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" python app.pyz
      
      - name: Upload Artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-artifacts
          path: |
            output/
            *.png
            *.html
            *.log
          retention-days: 5

      - name: Trigger another run
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Remove any existing " - Instance XXX" suffix to get the base name
          BASE_NAME=$(echo "${{ github.event.inputs.creator_name }}" | sed 's/ - Instance [0-9]*$//')
          
          # Trigger with clean base name + current instance number
          gh workflow run test-gen.yml \
            --ref ${{ github.ref_name }} \
            -f creator_name="${BASE_NAME} - Instance ${{ github.run_number }}" \
            -f max_retries="${{ github.event.inputs.max_retries || 10 }}"
